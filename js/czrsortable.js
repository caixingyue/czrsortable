/*
 * 作者：探す音夢
 * 功能：多区域拖动（压缩）图片插件
 * 时间：2018年8月12日
 * 版本：V1.0
 ***转载请注明出处***
*/
;(function($,window,document,undefined){var activeName={};var thisId=function(id){return document.getElementById(id)};var Operator=function(id,opt){activeName[id]=$.extend({},{density:false,url:false,urlTitle:false,css:'./css/czrsortable.css',width:false,height:false,maxcount:false,maxerror:'最多只能添加{count}张图片哦',sorcreate:{},},opt);if($('.sortable_tile').length<=0){$('head').append('<link>');css=$('head').children(':last');css.attr({rel:'stylesheet',type:'text/css',href:activeName[id].css})}};Operator.prototype={frame:function(id){$(thisId(id)).addClass('sortable_tile');if(!thisId(id+'_img')){$(thisId(id)).append('<div class="tile__list" id="'+id+'_img"></div>')}if(activeName[id].maxcount===false||$('#'+id+'_img div').length<activeName[id].maxcount){$(thisId(id+'_img')).append('<div class="lord forbidden" id="'+id+'_addimg"><img src="./images/addimg.png" /></div>')}$(thisId(id)).append('<input type="file" id="'+id+'_file" multiple accept="image/*" class="displaynone">')},sortable:function(id){Sortable.create(thisId(id+'_img'),$.extend({},{animation:150,filter:'.forbidden',},activeName[id].sorcreate))},operating:function(id){$(document).on('click touchstart','#'+id+'_addimg',function(){$('#'+id+'_file').click()});$(document).on('change','#'+id+'_file',function(){var sum=this.files.length;var count=sum+$('#'+id+'_img div').length-1;if(activeName[id].maxcount!==false&&count>activeName[id].maxcount){layer.msg(activeName[id].maxerror.replace('{count}',activeName[id].maxcount),{icon:5});return}var trendsum=$('#'+id+'_img div').length-1;for(var i=0;i<sum;i++){if(!(this.files[i].type.indexOf('image')==0&&this.files[i].type&&/\.(?:jpg|png|gif|jpeg|JPEG|JPG|PNG|GIF)$/.test(this.files[i].name))){layer.msg('仅支持格式为jpg,gif,png的图片文件',{icon:5})}else{var objimg={};var defaultaddimg='<div class="lord"><span class="button" style="display:block;"><span class="jobs del"></span></span>';if(activeName[id].url===true){defaultaddimg+='<span class="button buttonurl" style="display:block;"><span class="jobs url"></span></span>'}defaultaddimg+='<img src="{imgsrc}" /></div>';if(activeName[id].width>0){objimg['width']=activeName[id].width}if(activeName[id].height>0){objimg['height']=activeName[id].height}switch(activeName[id].density){case'lrz':lrz(this.files[i],objimg,function(results){$('#'+id+'_addimg').before(defaultaddimg.replace('{imgsrc}',results.base64));trendsum++;isAdd()});break;default:let reader=new FileReader();reader.readAsDataURL(this.files[i]);reader.onload=function(e){$('#'+id+'_addimg').before(defaultaddimg.replace('{imgsrc}',reader.result));trendsum++;isAdd()};break}}}function isAdd(){if(activeName[id].maxcount!==false&&trendsum>=activeName[id].maxcount){$('#'+id+'_addimg').remove()}}var file=$('#'+id+'_file');file.after(file.clone().val(""));file.remove()});$(document).on('click touchstart','#'+id+' .button .del',function(){var delinfo=$(this).parent().parent();delinfo.remove();if($('#'+id+'_addimg').length===0){$('#'+id+'_img').append('<div class="lord forbidden" id="'+id+'_addimg"><img src="./images/addimg.png" /></div>')}});$(document).on('click touchstart','#'+id+' .button .url',function(){selectimg=this.parentNode.parentNode.querySelector('img');layer.prompt({formType:0,title:activeName[id].urlTitle,value:selectimg.getAttribute('data-url'),},function(value,index,elem){if(value.match(/http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/)){selectimg.setAttribute('data-url',value);layer.close(index)}else{layer.tips('请输入正确的URL地址',elem)}})});$('#'+id+' .tile__list div').hover(function(){$(this).find('.button').slideDown()},function(){$(this).find('.button').slideUp()})}};$.dragimg=function(id,options){operator=new Operator(id,options);operator.frame(id);operator.sortable(id);operator.operating(id)};$.getdragimg=function(id,only){only=only||'';var data={};$('#'+id+'_img div').each(function(index,element){if(this.id!=id+'_addimg'){if(only=='src'){data[index]=this.querySelector('img').src}else if(only=='url'){data[index]=this.querySelector('img').getAttribute('data-url')}else{data[index]={};if(activeName[id].url===true){data[index]['url']=this.querySelector('img').getAttribute('data-url')}data[index]['src']=this.querySelector('img').src}}});return data}})(jQuery,window,document);